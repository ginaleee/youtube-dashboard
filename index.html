<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YouTube Multi-Channel Reports</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;background:#0b0f14;color:#e6edf3}
  header,footer{padding:16px 20px;background:#111826}
  main{padding:20px;max-width:1100px;margin:0 auto}
  .card{background:#0f1722;border:1px solid #1f2a3a;border-radius:12px;padding:16px;margin:12px 0}
  label{display:block;margin:8px 0 4px}
  select,input{padding:10px;border-radius:8px;border:1px solid #2a3a53;background:#0b1220;color:#e6edf3}
  button{padding:10px 14px;border-radius:10px;border:0;background:#6aa1ff;color:#071120;font-weight:700;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .grow{flex:1}
  #report section{margin:22px 0;padding-bottom:16px;border-bottom:1px dashed #24334a}
  .muted{color:#9ab}
  .small{font-size:12px}
  .right{float:right}
  @media print { header,.controls{display:none} body{background:#fff;color:#000} .card{border:0} }
</style>
</head>
<body>
<header>
  <strong>ğŸ“Š YouTube Report Builder</strong>
</header>

<main>
  <div class="card controls">
    <div class="row">
      <div class="grow">
        <label>ì±„ë„ ì„ íƒ (ë³µìˆ˜ ê°€ëŠ¥)</label>
        <select id="channelSelect" multiple size="4" class="grow"></select>
        <div class="small muted">* êµ¬ê¸€ ë¡œê·¸ì¸ í›„ ë‚´ ì±„ë„ ëª©ë¡ì´ ë³´ì…ë‹ˆë‹¤.</div>
      </div>
      <div>
        <label>ê¸°ê°„ ìœ í˜•</label>
        <select id="periodType">
          <option value="weekly">ì£¼ê°„</option>
          <option value="monthly" selected>ì›”ê°„</option>
          <option value="custom">ì»¤ìŠ¤í…€</option>
        </select>
        <label>ì‹œì‘</label><input type="date" id="startDate">
        <label>ì¢…ë£Œ</label><input type="date" id="endDate">
      </div>
      <div>
        <label>ëª©í‘œ</label>
        <select id="goal">
          <option value="subs">êµ¬ë…ì ì„±ì¥</option>
          <option value="watch">ì‹œì²­ì‹œê°„ ì¦ê°€</option>
          <option value="affiliate">ì–´í•„ë¦¬ì—ì´íŠ¸ ì „í™˜</option>
        </select>
        <label>ì‹œì¦Œ</label><input id="seasonal" placeholder="Black Friday ë“±">
      </div>
    </div>
    <div class="row">
      <button id="googleAuthBtn">â‘  Google ë¡œê·¸ì¸</button>
      <button id="fetchBtn" disabled>â‘¡ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="buildBtn" disabled>â‘¢ ë³´ê³ ì„œ ìƒì„± (ChatGPT)</button>
      <button onclick="window.print()">PDFë¡œ ì €ì¥/ì¸ì‡„</button>
    </div>
    <div id="status" class="small muted"></div>
  </div>

  <div id="report" class="card">
    <em class="muted">ì—¬ê¸°ì— ë³´ê³ ì„œê°€ ìƒì„±ë©ë‹ˆë‹¤.</em>
  </div>
</main>

<footer>
  <span class="small muted">Â© Report Builder</span>
</footer>

<script>
/** ==== 0) í™˜ê²½ ë³€ìˆ˜ (ì‹¤ì‚¬ìš© ì‹œ ë°±ì—”ë“œ í”„ë¡ì‹œ ì¶”ì²œ) ==== **/
const CONFIG = {
  OPENAI_PROXY_URL: "/api/openai", // ì„œë²„ì—ì„œ OpenAIë¡œ ì¤‘ê³„
  YT_PROXY_URL: "/api/youtube",    // ì„œë²„ì—ì„œ YouTube APIë¡œ ì¤‘ê³„(OAuth í† í° ì €ì¥)
};

/** ==== 1) êµ¬ê¸€ OAuth ë¡œê·¸ì¸ & ì±„ë„ ëª©ë¡ ==== **/
let authed = false;
document.getElementById('googleAuthBtn').onclick = async () => {
  try {
    document.getElementById('status').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘...';
    const res = await fetch(`${CONFIG.YT_PROXY_URL}/login`, {method:'POST'});
    const j = await res.json();
    if (j.ok){ authed = true; document.getElementById('status').textContent = 'ë¡œê·¸ì¸ ì„±ê³µ'; loadChannels(); }
    else throw new Error(j.error||'login failed');
  } catch(e){ document.getElementById('status').textContent = 'ë¡œê·¸ì¸ ì˜¤ë¥˜: '+e.message; }
};

async function loadChannels(){
  const sel = document.getElementById('channelSelect');
  sel.innerHTML = '';
  const res = await fetch(`${CONFIG.YT_PROXY_URL}/channels`);
  const {items=[]} = await res.json();
  items.forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c.id; opt.textContent = c.title;
    sel.appendChild(opt);
  });
  document.getElementById('fetchBtn').disabled = items.length===0;
}

/** ==== 2) ê¸°ê°„ ì„ íƒ ë³´ì¡° ==== **/
function getRange(){
  const type = document.getElementById('periodType').value;
  let s = document.getElementById('startDate').value;
  let e = document.getElementById('endDate').value;
  const today = new Date();
  if(type==='monthly'){
    const first = new Date(today.getFullYear(), today.getMonth(), 1);
    const last  = new Date(today.getFullYear(), today.getMonth()+1, 0);
    s = s || first.toISOString().slice(0,10);
    e = e || last.toISOString().slice(0,10);
  }
  if(type==='weekly'){
    const last7 = new Date(today); last7.setDate(today.getDate()-6);
    s = s || last7.toISOString().slice(0,10);
    e = e || today.toISOString().slice(0,10);
  }
  return {type, start:s, end:e};
}

/** ==== 3) ì±„ë„ë³„ ë°ì´í„° ìˆ˜ì§‘ (ì˜ˆ: í†µê³„, ìƒìœ„ ì˜ìƒ, ì‡¼ì¸  ì§€í‘œ ë“±) ==== **/
document.getElementById('fetchBtn').onclick = async () => {
  const sel = [...document.getElementById('channelSelect').selectedOptions].map(o=>o.value);
  if(sel.length===0){ alert('ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
  const range = getRange();
  document.getElementById('status').textContent = 'ë°ì´í„° ìˆ˜ì§‘ ì¤‘...';

  // ë°±ì—”ë“œì—ì„œ YouTube API í˜¸ì¶œí•˜ì—¬ í‘œì¤€í™”ëœ JSONìœ¼ë¡œ ë°˜í™˜í•˜ë„ë¡ êµ¬í˜„
  const res = await fetch(`${CONFIG.YT_PROXY_URL}/report`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({channelIds: sel, range})
  });
  const channelsJson = await res.json(); // ìœ„ì—ì„œ ì¤€ CHANNELS_JSON í˜•ì‹ìœ¼ë¡œ ëŒì•„ì˜¤ê²Œ
  window.__YT_DATA__ = channelsJson;
  document.getElementById('status').textContent = 'ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ';
  document.getElementById('buildBtn').disabled = false;
};

/** ==== 4) OpenAIì— í”„ë¡¬í”„íŠ¸ ì „ì†¡ â†’ HTML ë³´ê³ ì„œ ìˆ˜ì‹  ==== **/
document.getElementById('buildBtn').onclick = async () => {
  const range = getRange();
  const payload = {
    system: `
You are a senior YouTube growth strategist and analytics consultant.
You receive structured JSON metrics from 4 YouTube channels and produce:
(1) A period review (clarity-first, actionable),
(2) Next-period strategy (titles, thumbnails, schedule),
(3) Benchmark videos/channels with reasons),
(4) Keyword/hashtag ideas,
(5) 5-line executive checklist,
(6) Render-ready HTML sections with minimal CSS classes.

Constraints:
- Be concise, data-driven, and avoid fluff.
- Emphasize deltas vs previous period when provided.
- If metrics are sparse, state assumptions and give a lightweight plan.
- Output MUST be a single HTML string with <section> blocks and an <aside> summary.
- Include a final <footer> with â€œGenerated by ChatGPTâ€.
`,

    user: `
Generate a YouTube multi-channel report.

Period:
- type: ${range.type}
- range: ${range.start} to ${range.end}
- timezone: America/Los_Angeles

Business goals:
- focus: ${document.getElementById('goal').value}
- seasonal: ${document.getElementById('seasonal').value || 'none'}

Channels JSON:
${JSON.stringify(window.__YT_DATA__ || {channels:[]})}
`
  };
  document.getElementById('status').textContent = 'ChatGPTê°€ ë³´ê³ ì„œë¥¼ ìƒì„± ì¤‘...';
  const res = await fetch(CONFIG.OPENAI_PROXY_URL, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const {html} = await res.json(); // ì„œë²„ê°€ model ì‘ë‹µì—ì„œ HTMLë§Œ ì¶”ì¶œí•´ {html}ë¡œ ë¦¬í„´
  document.getElementById('report').innerHTML = html || '<p>ìƒì„± ì‹¤íŒ¨</p>';
  document.getElementById('status').textContent = 'ì™„ë£Œ';
};
</script>
</body>
</html>
